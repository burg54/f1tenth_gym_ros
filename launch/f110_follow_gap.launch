from launch import LaunchDescription
from launch.actions import ExecuteProcess
#from launch.actions import Shutdown
from launch.event_handlers import OnProcessExit
from launch_ros.actions import Node
from launch.events import Shutdown
from launch.actions import (
    DeclareLaunchArgument,
    EmitEvent,
    ExecuteProcess,
    LogInfo,
    RegisterEventHandler,
    TimerAction
)
from launch.event_handlers import (
    OnExecutionComplete,
    OnProcessExit,
    OnProcessIO,
    OnProcessStart,
    OnShutdown
)
from launch.substitutions import (
    EnvironmentVariable,
    FindExecutable,
    LaunchConfiguration,
    LocalSubstitution,
    PythonExpression
)

def generate_launch_description():

    follow_gap_node = Node(
        package='f1tenth_gym_ros',
        namespace='gap_ns',
        executable='follow_gap',
        name='gap'
    )

    stop_car_node = Node(
        package='f1tenth_gym_ros',
        namespace='stop_ns',
        executable='stop_car',
        name='stop'
    )

    stop_car_action = ExecuteProcess(
        cmd=['ros2 ', 
            ' topic pub --once ',
            '/cmd_vel ',
            'geometry_msgs/msg/Twist ',
            '"{linear: {x: 0.0}, angular: {z: 0.0}}"', 
        ],
        shell=True
    )

    stop_car_action2 = ExecuteProcess(
        cmd=[[
            FindExecutable(name='ros2'),
            ' topic pub --once ',
            '/cmd_vel ',
            'geometry_msgs/msg/Twist ',
            '"{linear: {x: 0.0}, angular: {z: 0.0}}"', 
        ]],
        shell=True
    )

    return LaunchDescription([
        follow_gap_node,
        RegisterEventHandler(
            OnProcessStart(
                target_action=follow_gap_node,
                on_start=[
                    LogInfo(msg='F1/tenth started, start race.'),
                ]
            )
        ),
        RegisterEventHandler(
            OnProcessExit(
                target_action=follow_gap_node,
                on_exit=[
                    LogInfo(msg=(EnvironmentVariable(name='USER'),
                            ' stopped the follow-the-gap algorithm')),
                    EmitEvent(event=Shutdown(
                        reason='Control+c'))
                ]
            )
        ),
        RegisterEventHandler(
            OnShutdown(
                on_shutdown=[LogInfo(
                    msg=['Launch was asked to shutdown: ', LocalSubstitution('event.reason')]
                )]
            )
        ),
    ])
